import wave
import numpy as np
import pyCompressor

def read_wav(file_path):
    """Read a .wav file and return the audio data and sample rate."""
    with wave.open(file_path, 'rb') as wav_file:
        sample_rate = wav_file.getframerate()
        frames = wav_file.readframes(-1)
        audio_data = np.frombuffer(frames, dtype=np.int16)
    return audio_data, sample_rate

def write_wav(file_path, audio_data, sample_rate):
    """Write audio data to a .wav file."""
    with wave.open(file_path, 'wb') as wav_file:
        wav_file.setnchannels(1)  # Mono
        wav_file.setsampwidth(2)  # 16-bit
        wav_file.setframerate(sample_rate)
        wav_file.writeframes(audio_data.astype(np.int16).tobytes())

def apply_gain(audio_data, gain):
    """Apply gain to the audio data."""
    return audio_data * gain

def normalize_audio(audio_data):
    """
    Normalize audio data to a target peak amplitude (90% of the maximum possible amplitude).
    Automatically calculate the required gain.
    """
    target_peak = 0.9 * 32767  # 90% of the maximum 16-bit amplitude
    max_amplitude = np.max(np.abs(audio_data))

    if max_amplitude == 0:
        return audio_data, 1.0  # Avoid division by zero, return original data and gain = 1.0

    # Calculate the required gain to normalize to the target peak
    gain = target_peak / max_amplitude
    return audio_data * gain, gain

def process_audio(file_path, output_path, volumetype, gain=None):
    """Process the audio file based on volumetype and apply compression."""
    # Read the .wav file
    audio_data, sample_rate = read_wav(file_path)

    # Apply gain based on volumetype
    if volumetype == 0:
        if gain is None:
            raise ValueError("Gain must be provided when volumetype is 0.")
        audio_data = apply_gain(audio_data, gain)
    elif volumetype == 1:
        audio_data, auto_gain = normalize_audio(audio_data)
        print(f"Automated gain for normalization: {auto_gain:.2f}")

    # Apply compression to prevent hearing damage
    compressor = pyCompressor.Compressor(threshold=-20.0, ratio=4.0, attack=0.01, release=0.1)
    audio_data = compressor.process(audio_data)

    # Write the processed audio to a new .wav file
    write_wav(output_path, audio_data, sample_rate)

# Example usage
input_file = "input.wav"
output_file = "output.wav"
volumetype = 1  # 0 for fixed gain, 1 for normalization

# If volumetype is 0, provide a gain value. If volumetype is 1, gain is automated.
process_audio(input_file, output_file, volumetype, gain=None)
print(f"Processed audio saved to {output_file}")
